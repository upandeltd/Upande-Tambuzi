[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 0,
  "modified": "2025-02-16 13:37:37.485949",
  "module": "Upande Tambuzi",
  "name": "Scan QR Button",
  "script": "frappe.ui.form.on('Scan', {\n    refresh(frm) {\n        frm.add_custom_button(\"Scan QR Code\", () => {\n            \n            const farm = cur_frm.doc.farm;\n            const action = cur_frm.doc.action;\n                        \n            if (!farm || !action) {\n                frappe.throw(\"Please select a farm and action before scanning.\");\n                return;\n            }\n            \n            if (!window.Html5Qrcode) {\n                const script = document.createElement(\"script\");\n                script.src = \"https://unpkg.com/html5-qrcode\";\n                script.onload = () => {\n                    console.log(\"Html5Qrcode library loaded successfully.\");\n                    showQrScannerDialog();\n                };\n                script.onerror = () => {\n                    console.error(\"Failed to load Html5Qrcode library.\");\n                    frappe.msgprint(\"Failed to load QR scanning library. Please check your network connection.\");\n                };\n                document.head.appendChild(script);\n            } else {\n                showQrScannerDialog();\n            }\n            \n            \n            \n            function showQrScannerDialog() {\n                const dialog = new frappe.ui.Dialog({\n                    title: \"Scan QR Code\",\n                    fields: [\n                        { fieldname: 'qr_scanner', fieldtype: 'HTML', options: '' }\n                    ]\n                });\n\n                const $wrapper = dialog.fields_dict.qr_scanner.$wrapper;\n                $wrapper.html('<div id=\"qr-reader\" style=\"width: 100%;\"></div>');\n\n                dialog.show();\n\n                setTimeout(() => {\n                    const qrReaderElement = document.getElementById(\"qr-reader\");\n                    if (qrReaderElement) {\n                        initializeQrScanner(qrReaderElement, dialog);\n                    } else {\n                        console.error(\"QR Reader element not found!\");\n                        frappe.msgprint(\"Error initializing QR scanner. Please try again.\");\n                    }\n                }, 300);\n            }\n            \n            let isProcessing = false;\n            let createStock = false;\n            let boxLabelData  = null;\n            let isPaused = false;\n            let farmPackListDocId = null;\n            let boxStickerDocId = null;\n            let stockEntryDoc;\n            \n            function initializeQrScanner(qrReaderElement, dialog) {\n                const html5QrCode = new Html5Qrcode(\"qr-reader\");\n\n                html5QrCode.start(\n                    { facingMode: \"environment\" }, \n                    {\n                        fps: 15, \n                        qrbox: { width: 250, height: 250 } \n                    },\n                    async (decodedText, decodedResult) => {\n                        if (isProcessing || isPaused) {\n                            return;\n                        }\n                        isProcessing = true;\n                        \n                        try {\n                            if (action === \"Packing\") {\n                                if (!boxLabelData) {\n                                    boxLabelData = decodedText;\n                                    \n                                    \n                                    frappe.msgprint(`Box label scanned. Please scan the bunch label. ${boxLabelData}`);\n                          \n                                    isPaused = true;\n                                    \n                                    frappe.confirm(\"Ready to scan the bunch label?\", () => {\n                                        isPaused = false;\n                                    });\n                                    \n                                    isProcessing = false;\n                                    return;\n                                } else {\n                                    const bunchLabelData = decodedText;\n                                    \n                                    const urlArray = decodedText.split(\"/\");\n                                    const arrayLength = urlArray.length;\n                                    const stockEntryName = urlArray[arrayLength - 1];\n                                    \n                                    try {\n                                        stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n                                    } catch (error) {\n                                        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n                                    }\n                                    \n                                    if (stockEntryDoc.custom_scanned ) {\n                                        frappe.throw(\"Bunch aready scanned!\");\n                                        return;\n                                    }\n                                    \n                                    const varietyMatch = await validateLabels(boxLabelData, bunchLabelData);\n                                    \n                                    if (!varietyMatch) {\n                                        frappe.throw(\"Bunch label does not match the box label!\");\n                                    } else {\n                                        frappe.msgprint(\"Bunch and Box labels match!\")\n                                        \n                                        \n                                        await createOrGetFarmPackList(boxLabelData, bunchLabelData)\n                                        \n                                        \n                                        if (!boxStickerDocId) {\n                                            await createBoxSticker(boxLabelData, bunchLabelData)\n                                        } else {\n                                            await addVarietyToBoxSticker(boxStickerDocId, bunchLabelData);\n                                        }\n                                        \n                                        try {\n                                            await createStockEntry(bunchLabelData, farm, action);\n                                            frappe.msgprint(`Transfered stock successfully`);\n                                        } catch (error) {\n                                            frappe.throw(`Error creating stock entry: ${error}`)\n                                        }\n                                            \n                                        isPaused = true;\n                                    \n                                        frappe.confirm(\"Bunch Scanned! Ready to scan the next bunch label? Press No to CLOSE box\", () => {\n                                            isPaused = false;\n                                        });\n                                    }\n                                    // isPaused = true;\n                                }\n                            }\n                            \n                            if (action == \"Receiving\" ) {\n                               \n\n                                createStock = true;\n                            }\n                            \n                            \n                            if (createStock) {\n                                const doc_name = await createStockEntry(decodedText, farm, action);\n                                frappe.msgprint(`Created Stock Entry successfully`);\n                                html5QrCode.stop();\n                                dialog.hide();\n                            }\n                            \n                        } catch (error) {\n                            frappe.throw(`Error while creating stock entry: ${error}`)\n                        } finally {\n                            isProcessing = false;\n                        }\n                        \n                        \n                        \n                    },\n                    (errorMessage) => {\n                        console.warn(\"Scanning error:\", errorMessage);\n                    }\n                ).catch((err) => {\n                    console.error(\"Error starting QR scanner:\", err);\n                    frappe.msgprint(\"Unable to access the camera. Please ensure permissions are granted and try again.\");\n                });\n\n                dialog.on(\"hide\", function () {\n                    html5QrCode.stop().then(() => {\n                        console.log(\"QR Scanner stopped.\");\n                    }).catch((err) => {\n                        console.error(\"Error stopping QR scanner:\", err);\n                    });\n                });\n            }\n            \n            function getStockEntryIdFromUrl(stockEntryUrl) {\n                const stock_entry_url_arr = stockEntryUrl.split(\"/\");\n                const arrLength = stock_entry_url_arr.length;\n                const stock_entry_id = stock_entry_url_arr[arrLength - 1];\n                \n                return stock_entry_id;\n            }\n            \n            async function createOrGetFarmPackList(boxLabelData, bunchLabelData) {\n                const { sales_order, farm } = await getSalesOrderAndFarmFromOPL(boxLabelData);\n                \n                if (!sales_order || farm == \"Unknown\" ) {\n                    frappe.throw(\"Sales Order or Warehouse details missing in Order Pick List.\");\n                    return;\n                }\n                \n                const existingFPL = await frappe.db.get_list(\"Farm Pack List\", {\n                    filters: {\n                        custom_sales_order: sales_order,\n                        custom_farm: farm\n                    },\n                    fields: [\"name\"]\n                    \n                })\n                \n                if (existingFPL.length > 0) {\n                    farmPackListDocId = existingFPL[0].name;\n                    await addBunchToFarmPackList(farmPackListDocId, bunchLabelData, boxLabelData, farm);\n                    frappe.msgprint(`Bunch added to existing Farm Pack List: ${farmPackListDocId}`);\n                } else {\n                    await createFarmPackListEntry(bunchLabelData, boxLabelData, farm);\n                }\n                \n                return;\n                \n            }\n            \n            async function getSalesOrderAndFarmFromOPL(boxLabelData) {\n                const parsedBoxData = JSON.parse(boxLabelData);\n                const orderPickListId = parsedBoxData.order_id;\n                \n                const oplDoc = await frappe.db.get_doc('Order Pick List', orderPickListId);\n                \n                if (!oplDoc) {\n                    frappe.throw(\"Order Pick List not found for the given box label.\");\n                }\n                \n                // Can also be fetched from the direct field; \"source_warehouse\"\n                const farmName = oplDoc.locations[0].warehouse?.split(\" \")[0]\n                                || oplDoc.source_warehouse?.split(\" \")[0]\n                                || oplDoc.locations[0].custom_source_warehouse?.split(\" \")[0]\n                                || \"Unknown\";\n            \n                return {\n                    sales_order: oplDoc.sales_order,\n                    farm: farmName\n                };\n            }\n            \n            async function createBoxSticker(boxLabelData, bunchLabelData) {\n                try {\n                    const parsedBoxData = JSON.parse(boxLabelData);\n                    const orderId = parsedBoxData.order_id;\n                    const box_id = parsedBoxData.box_id;\n                    const stockEntryId = getStockEntryIdFromUrl(bunchLabelData);\n\n                    // Fetch Sales Order & Stock Entry\n                    const orderPick = await frappe.db.get_doc(\"Order Pick List\", orderId);\n                    \n                    const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n                    \n                    const itemCode = stockEntry.items[0].item_code;\n                    const uom = stockEntry.items[0].uom;\n                    const length = stockEntry.custom_stem_length;\n                    const customerId = orderPick.customer;\n                    \n                    const response = await frappe.call({\n                        method: 'upande_tambuzi.server_scripts.create_box_sticker.create_box_sticker',\n                        args: {\n                            variety: itemCode,\n                            uom: uom,\n                            customer: customerId,\n                            length: length,\n                            box_number: box_id,\n                        },\n                        callback: function (response) {\n                            boxStickerDocId = response.message.docname\n                            frappe.msgprint(\"Box Label Sticker Created Successfully!\")\n                        }\n                    })\n                    \n                    \n                    \n                } catch (err) {\n                    frappe.throw(`Error creating Box Label: ${err}`)\n                }\n            }\n            \n            \n            async function addVarietyToBoxSticker(boxStickerDocId, bunchLabelData) {\n                try {\n                    const stockEntryId = getStockEntryIdFromUrl(bunchLabelData);\n                    const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n                    \n                    const variety = stockEntry.items[0].item_code\n                    const uom = stockEntry.items[0].uom\n                    \n                    const response = frappe.call({\n                        method: 'upande_tambuzi.server_scripts.add_variety_to_box_sticker.add_variety_to_sticker',\n                        args: {\n                            box_label_sticker_name: boxStickerDocId,\n                            variety: variety,\n                            uom: uom\n                        },\n                        callback: function (response) {\n                            frappe.msgprint(`${variety} added to Box Label Sticker`)\n                        }\n                    })\n\n                } catch (err) {\n                    frappe.throw(`Error adding ${variety} to Box Label Sticker: ${err}`)\n                }\n            }\n            \n            \n            async function createFarmPackListEntry(bunchLabelData, boxLabelData, farm) {\n                try {\n                    const parsedBoxData = JSON.parse(boxLabelData);\n                    const orderId = parsedBoxData.order_id;\n                    const stockEntryId = getStockEntryIdFromUrl(bunchLabelData);\n\n                    // Fetch Sales Order & Stock Entry\n                    const orderPick = await frappe.db.get_doc(\"Order Pick List\", orderId);\n                    \n                    const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n            \n                    if (!orderPick || !stockEntry || !stockEntry.items.length) {\n                        frappe.throw(\"Invalid Sales Order or Stock Entry data\");\n                    }\n            \n                    const sourceWarehouse = `${farm} Packed Store - TL`;\n            \n                    const itemCode = stockEntry.items[0].item_code;\n                    const uom = stockEntry.items[0].uom;\n                    \n                    // Quantity scanned should always be one per scan\n                    const quantity = 1;\n                    const customerId = orderPick.customer;\n                    const sales_order_id = orderPick.sales_order;\n                    const boxId = parsedBoxData.box_id;\n            \n                    // Create new Farm Pack List document\n                    const packListDoc = frappe.model.get_new_doc(\"Farm Pack List\");\n                    packListDoc.custom_sales_order = sales_order_id;\n                    packListDoc.custom_farm = farm;\n                    packListDoc.pack_list_item = [{\n                        item_code: itemCode,\n                        uom: uom,\n                        qty: quantity,\n                        source_warehouse: sourceWarehouse,\n                        sales_order_id: sales_order_id,\n                        customer_id: customerId,\n                        box_id: boxId\n                    }];\n                    \n                    // Save document\n                    const savedDoc = await frappe.db.insert(packListDoc);\n                    \n                    farmPackListDocId = savedDoc.name;\n\n                    frappe.msgprint(\"Farm Pack List entry created successfully!\");\n            \n                } catch (error) {\n                    console.error(\"Error saving Farm Pack List:\", error);\n                    frappe.throw(`Error saving Farm Pack List: ${error.message}`);\n                }\n            }\n\n            \n            \n            async function addBunchToFarmPackList(farmPackListDocId, bunchLabelData, boxLabelData, farm) {\n                try {\n                    await frappe.call({\n                        method: 'upande_tambuzi.server_scripts.update_farm_pack_list.add_bunch_to_farm_pack_list',\n                        args: {\n                            farm_pack_list_doc_id: farmPackListDocId,\n                            bunch_label_data: bunchLabelData,\n                            box_label_data: boxLabelData, \n                            farm: farm,\n                        },\n                        callback: function (response) {\n                            frappe.msgprint(`Added bunch to Farm Pack List: ${farmPackListDocId}`);\n                        }\n                    });\n                } catch (error) {\n                    console.error('Error adding bunch to Farm Pack List:', error);\n                    frappe.throw(`Error adding bunch to Farm Pack List: ${error}`);\n                }\n            }\n\n\n            async function validateLabels(boxLabelData, bunchLabelData) {\n                const stock_entry_url_arr = bunchLabelData.split(\"/\");\n                const arrLength = stock_entry_url_arr.length;\n                const stock_entry_id = stock_entry_url_arr[arrLength - 1];\n                \n                const parsedBoxData = JSON.parse(boxLabelData);\n                const orderId = parsedBoxData.order_id;\n                \n                let orderPickVariety;\n                let stockEntryVariety;\n                \n                // Get the variety associated with the stock_entry_id (bunch) first\n                try {\n                    const stockEntryDocument = await frappe.db.get_doc('Stock Entry', stock_entry_id);\n                    \n                    if (stockEntryDocument) {\n                        stockEntryVariety = stockEntryDocument.items[0].item_code;\n                    } else {\n                        frappe.msgprint(`No Stock Entry found for ${stock_entry_id}`);\n                    }\n                } catch (error) {\n                    frappe.throw(`Error fetching Stock Entry: ${error}`);\n                }\n                \n                // Get the variety associated with the order_pick_list and stockEntryVariety\n                try {\n                    const orderPickList = await frappe.db.get_doc(\"Order Pick List\", orderId);\n                    const numberOfItems = orderPickList.locations.length;\n                    \n                    if (orderPickList) {\n\n                        for (let i = 0; i < numberOfItems; i++) {\n                            let currVariety = orderPickList.locations[i].item_code;\n                            \n                            if (currVariety === stockEntryVariety ) {\n                                orderPickVariety = currVariety;\n                            }\n                        }\n                        \n                    } else {\n                        frappe.msgprint(`No Order Pick List found for ${orderId}`);\n                    }\n                } catch (error) {\n                    frappe.throw(`Error fetching Order Pick List: ${error}`);\n                }\n                \n                \n                \n                if (orderPickVariety !== stockEntryVariety) {\n                    return false;\n                }\n                \n                return true;\n            } \n            \n            async function createStockEntry(decodedText, farm, action) {\n                const urlArray = decodedText.split(\"/\");\n                const arrayLength = urlArray.length;\n                const stockEntryName = urlArray[arrayLength - 1];\n                \n                \n                let variety;\n                let qty;\n                let breeder;\n                let grower;\n                let uom;\n                let harvester;\n                let greenhouse;\n                let block__bed_number;\n                \n                // Use the stockEntryName to get the stock_entry_data field data needed for\n                // stock transfer\n                if (action == \"Receiving\") {\n                    try {\n                        stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n                    } catch (error) {\n                        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n                    }\n                    \n                    if (stockEntryDoc.custom_scanned ) {\n                        frappe.throw(\"Bucket aready scanned!\");\n                        return;\n                    }\n                    \n                    const items = stockEntryDoc.items;\n                    \n                    breeder = stockEntryDoc.custom_breeder;\n                    grower = stockEntryDoc.custom_grower;\n                    greenhouse = stockEntryDoc.custom_greenhouse;\n                    harvester = stockEntryDoc.custom_harvester;\n                    block__bed_number = stockEntryDoc.custom_block__bed_number\n                    \n                    \n                    items.forEach((item) => {\n                        variety = item.item_code;\n                        qty = item.qty;\n                    });\n                }\n                \n                if (action === \"Packing\") {\n                    try {\n                        stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n                    } catch (error) {\n                        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n                    }\n                    \n                    \n                    \n                    const items = stockEntryDoc.items;\n                    \n                    items.forEach((item) => {\n                        variety = item.item_code;\n                        \n                        // Flowers are packed per 1 bunch\n                        qty = 1;\n                        uom = item.uom;\n                    });\n                }\n                \n                const stock_entry_type_mapping = {\n                    \"Receiving\": \"Receiving\",\n                    \"Grading\": \"\",\n                    \"Packing\": \"Packing\",\n                    \"Loading to Truck\": \"Material Transfer\"\n                };\n                \n                const stock_entry_type = stock_entry_type_mapping[action];\n                \n                // Maps the location of scan to the movement of stock\n                const locationMapping = {\n                    \"Burguret Receiving\": { source: `${greenhouse}`, target: \"Burguret Receiving Cold Store - TL\" },\n                    // \"Burguret Grading\": { source: \"Burguret Ungraded Store - TL\", target: \"Burguret Graded Store - TL\" },\n                    \"Burguret Packing\": { source: \"Burguret Graded Sold - TL\", target: \"Burguret Dispatch Cold Store - TL\" },\n                    // \"Burguret Loading to Truck\": { source: \"Burguret - Packaging\", target: \"Burguret - Packaging\" },\n                    \"Turaco Receiving\": { source: `${greenhouse}`, target: \"Turaco Receiving Cold Store - TL\" },\n                    // \"Turaco Grading\": { source: \"Turaco Ungraded Store - TL\", target: \"Turaco Graded Store - TL\" },\n                    \"Turaco Packing\": { source: \"Turaco Graded Sold - TL\", target: \"Turaco Dispatch Cold Store - TL\" },\n                    // \"Turaco Loading to Truck\": { source: \"Turaco - Packaging\", target: \"Turaco - Packaging\" },\n                    \"Pendekeza Receiving\": { source: `${greenhouse}`, target: \"Pendekeza Receiving Cold Store - TL\" },\n                    // \"Pendekeza Grading\": { source: \"Pendekeza Ungraded Store - TL\", target: \"Pendekeza Graded Store - TL\" },\n                    \"Pendekeza Packing\": { source: \"Pendekeza Graded Sold - TL\", target: \"Pendekeza Dispatch Cold Store - TL\" }\n                    // \"Pendekeza Loading to Truck\": { source: \"Pendekeza - Packaging\", target: \"Pendekeza - Packaging\" }\n                };\n                \n                const scanLocation = `${farm} ${action}`;\n                \n                const stockmvt = locationMapping[scanLocation];\n\n                if (!stockmvt) {\n                    frappe.msgprint(`Invalid scan location: ${scanLocation}`);\n                    return;\n                }\n                stock_entry_data = {\n                    \"location data\": stockmvt,\n                    \"variety\": variety,\n                    \"quantity\": qty,\n                    \"breeder\": breeder,\n                    \"grower\": grower,\n                    \"harvester\": harvester,\n                    \"greenhouse\": greenhouse,\n                    \"stock entry type\": stock_entry_type,\n                    \"uom\": uom,\n                    \"block__bed_number\": block__bed_number\n                };\n            \n                const created_stock_entry = frappe.call({\n                    method: \"upande_tambuzi.server_scripts.create_stock_entry.create_stock_entry\",\n                    args: {\n                        stock_entry_data: JSON.stringify(stock_entry_data),\n                    }\n                });\n                \n                await frappe.call({\n                    method: \"upande_tambuzi.server_scripts.update_custom_scanned.update_custom_scanned\",\n                    args: { stock_entry_name: stockEntryName }\n                });\n\n\n                return created_stock_entry;\n\n            }\n            \n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-01-25 20:29:13.185615",
  "module": "Upande Tambuzi",
  "name": "Populate Number of Items",
  "script": "frappe.ui.form.on('Stock Entry', {\n    refresh: function(frm){\n        $.each(frm.doc.items, function(i, row){\n            if (row.uom == 'Stems') {\n                row.custom_number_of_stems = row.qty;\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-02-12 17:40:06.907542",
  "module": "Upande Tambuzi",
  "name": "Grading Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    custom_farm: function(frm) {\n        if (frm.doc.stock_entry_type === \"Grading\") {\n            let warehouseMapping = {\n                \"Burguret\": { source: \"Burguret Receiving Cold Store - TL\", target: \"Burguret Graded General - TL\" },\n                \"Turaco\": { source: \"Turaco Receiving Cold Store - TL\", target: \"Turaco Graded General - TL\" },\n                \"Pendekeza\": { source: \"Pendekeza Receiving Cold Store - TL\", target: \"Pendekeza Graded General - TL\" }\n            };\n\n            let selectedFarm = frm.doc.custom_farm;\n\n            if (selectedFarm && warehouseMapping[selectedFarm]) {\n                frm.set_value(\"from_warehouse\", warehouseMapping[selectedFarm].source);\n                frm.set_value(\"to_warehouse\", warehouseMapping[selectedFarm].target);\n            }\n        }\n    },\n\n    stock_entry_type: function(frm) {\n        if (frm.doc.stock_entry_type === \"Grading\") {\n            frm.trigger(\"custom_farm\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-02-12 18:42:08.156892",
  "module": "Upande Tambuzi",
  "name": "Field Rejects Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    custom_farm: function(frm) {\n        if (frm.doc.stock_entry_type === \"Field Rejects\") {\n            const greenhouse = frm.doc.custom_greenhouse;\n            \n            let warehouseMapping = {\n                \"Burguret\": { source: `${greenhouse}`, target: \"Burguret Field Rejects - TL\" },\n                \"Turaco\": { source: `${greenhouse}`, target: \"Turaco Field Rejects - TL\" },\n                \"Pendekeza\": { source: `${greenhouse}`, target: \"Pendekeza Field Rejects - TL\" }\n            };\n\n            let selectedFarm = frm.doc.custom_farm;\n\n            if (selectedFarm && warehouseMapping[selectedFarm]) {\n                frm.set_value(\"from_warehouse\", warehouseMapping[selectedFarm].source);\n                frm.set_value(\"to_warehouse\", warehouseMapping[selectedFarm].target);\n            }\n        }\n    },\n\n    stock_entry_type: function(frm) {\n        if (frm.doc.stock_entry_type === \"Field Rejects\") {\n            frm.trigger(\"custom_farm\");\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-02-19 02:29:04.146249",
  "module": "Upande Tambuzi",
  "name": "Qr Code gen",
  "script": "frappe.ui.form.on('Stock Entry', {\n    after_save: function(frm) {\n        if (frm.doc.docstatus === 0 && frm.doc.stock_entry_type === 'Grading') {\n            \n            const grading_details = {\n                \"name\": frm.doc.name,\n                \"variety\": frm.doc.items[0].item_code,\n                \"grader\": frm.doc.custom_graded_by,\n                \"qty\": frm.doc.items[0].qty,\n            };\n            \n            const response = frappe.call({\n                method: \"upande_tambuzi.server_scripts.qr_code_generator.generate_qr_code\",\n                args: {\n                    stock_entry_details: JSON.stringify(grading_details)\n                },\n            });\n            \n           \n            \n        }\n    },\n\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-02-16 13:38:22.614916",
  "module": "Upande Tambuzi",
  "name": "Scan Data Field Listener",
  "script": "frappe.ui.form.on('Scan', {\n    refresh(frm) {\n        if (!frm.fields_dict.scan_data.$wrapper.hasClass('scan-data-bound')) {\n            frm.fields_dict.scan_data.$wrapper.on('change', function () {\n                frm.script_manager.trigger('scan_data');\n            });\n\n            frm.fields_dict.scan_data.$wrapper.addClass('scan-data-bound');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-02-19 21:54:33.165049",
  "module": "Upande Tambuzi",
  "name": "Scan Via Honeywell",
  "script": "frappe.ui.form.on('Scan', {\n\trefresh(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\tfarm(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\taction(frm) {\n\t    toggle_scan_data_field(frm);\n\t},\n\t\n\tasync scan_data(frm) {\n\t    \n\n\t    let scan_value = frm.doc.scan_data;\n\t    let farm = frm.doc.farm;\n        let action = frm.doc.action;\n\n\t    if (scan_value && !frm.is_processing_stock_entry) {\n\t        frm.is_processing_stock_entry = true;\n\t        frm.set_df_property('scan_data', 'read_only', 1);\n\n\t        if (action === 'Packing') {\n\t            if (!frm.doc.opl_data) {\n\t                \n\t                frm.set_value('opl_data', scan_value);\n\n\t                frappe.msgprint('Order Pick List scanned. Now scan bunch labels.');\n\t                frm.set_df_property('scan_data', 'read_only', 0);\n\t                frm.set_value('scan_data', '');\n\n\n\t                frm.is_processing_stock_entry = false;\n\t            } else {\n\t                const dataParts = scan_value.split(';');\n                    const parsedData = {};\n                    \n                    // Convert the key-value pairs into an object\n                    dataParts.forEach(part => {\n                        const [key, value] = part.split('=');\n                        if (key && value) {\n                            parsedData[key] = value;\n                        }\n                    });\n\t                \n\t                let bunchLabelData = parsedData.url;\n\t                try {\n                        await process_bunch_scan(frm.doc.opl_data, bunchLabelData, farm, action);\n                        frappe.msgprint('Bunch scanned. Scan next bunch or Close Box');\n                        frm.set_df_property('scan_data', 'read_only', 0);\n                        frm.set_value('scan_data', '');\n                    } catch (error) {\n                        frappe.msgprint(`Error processing bunch scan: ${error.message}`);\n                        \n                    }\n\t                \n                    frm.set_df_property('scan_data', 'read_only', 0);\n\t                frm.set_value('scan_data', '');\n\t                frm.is_processing_stock_entry = false;\n\t            }\n\t           \n\t            \n\t        } else if (action === 'Receiving') {\n                trigger_stock_entry(scan_value, farm, action).finally(() => {\n                    frm.set_df_property('scan_data', 'read_only', 0);\n                    frm.set_value('scan_data', '');\n                    frm.is_processing_stock_entry = false;\n                });\n            } else if (action === 'Receiving Quarantined') {\n                await trigger_stock_entry(scan_value, farm, action).finally(() => {\n                    frm.set_df_property('scan_data', 'read_only', 0);\n                    frm.set_value('scan_data', '');\n                    frm.is_processing_stock_entry = false;\n                });\n                \n            } else if (action === 'Id') {\n                let stockEntryName;\n                \n                let variety, qty, breeder, grower, uom, harvester, greenhouse, block__bed_number, stockEntryDoc, items,\n                    stem_length, graded_by, bunched_by;\n                \n                // This is grading qr code data\n                if ( scan_value.includes(\"url=\") && scan_value.includes(\"bunch_id=\") ) {\n                    \n                    const params = Object.fromEntries(\n                        scan_value.split(';').map(pair => pair.trim().split('='))\n                    );\n                    \n                    const decodedUrl = params.url;\n                    stockEntryName = getNameFromUrl(decodedUrl);\n                    \n                    try {\n                        stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n                        \n                    } catch (error) {\n                        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n                    }\n                    \n                    items = stockEntryDoc.items;\n                    \n                    stem_length = stockEntryDoc.custom_stem_length;\n                    graded_by = stockEntryDoc.custom_graded_by;\n                     \n                    variety = items[0].item_code;\n                    bunched_by = items[0].uom;\n                    qty = items[0].qty;\n                    \n                    frappe.msgprint(`Graded by: ${graded_by}, Variety: ${variety}, Bunched By: ${bunched_by}, Quantity: ${qty}, Stem Length: ${stem_length}`)\n                    \n                    \n                // This is harvesting qr code data\n                } else if (scan_value.startsWith('http')) {\n                    stockEntryName = getNameFromUrl(scan_value);\n                    \n                    try {\n                        stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n                        \n                    } catch (error) {\n                        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n                    }\n                \n                    items = stockEntryDoc.items;\n                    \n                    breeder = stockEntryDoc.custom_breeder;\n                    grower = stockEntryDoc.custom_grower;\n                    greenhouse = stockEntryDoc.custom_greenhouse;\n                    harvester = stockEntryDoc.custom_harvester;\n                    block__bed_number = stockEntryDoc.custom_block__bed_number;\n            \n                    \n                    items.forEach((item) => {\n                        variety = item.item_code;\n                        qty = item.qty;\n                    });\n                    \n                    frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, Variety: ${variety}, No. of Stems: ${qty} `);\n                }\n                \n                \n            \n                frm.set_df_property('scan_data', 'read_only', 0);\n                frm.set_value('scan_data', '');\n                frm.is_processing_stock_entry = false;\n                \n            } \n\t    }\n\t}\n\t\n});\n\n\nlet farmPackListDocId = null;\nlet boxStickerDocId = null;\n\n\n\nfunction getNameFromUrl(url) {\n    const urlArray = url.split(\"/\");\n    const arrayLength = urlArray.length;\n    const name = urlArray[arrayLength - 1];\n    \n    return name;\n}\n\n\n\nasync function trigger_stock_entry(scan_value, farm, action) {\n    await createStockEntry(scan_value, farm, action);\n    if (action === 'Receiving') {\n        frappe.msgprint(`Received Bucket and Created Stock Entry successfully`);\n        frappe.msgprint(``)\n    } else if (action === 'Receiving Quarantined') {\n        frappe.msgprint(`Received and moved Bucket to quarantine`);\n    }\n    \n}\n\n\n\nasync function process_bunch_scan(opl_url, bunchLabelData, farm, action) {\n    const oplName = getNameFromUrl(opl_url);\n    const bunchStockEntryName = getNameFromUrl(bunchLabelData);\n    let bunchName;\n    \n    // Incremented with successful scans\n    let scannedItems = 0;\n    let totalBunches = 0;\n    \n    \n    \n    let stockEntryDoc;\n    try {\n        stockEntryDoc = await frappe.db.get_doc('Stock Entry', bunchStockEntryName);\n    } catch (error) {\n        frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n    }\n    \n    if (stockEntryDoc.custom_scanned ) {\n        frappe.throw(\"Bunch aready scanned!\");\n        return;\n    }\n    \n    // frappe.call({\n    //     method: \"upande_tambuzi.server_scripts.update_custom_scanned.update_custom_scanned\",\n    //     args: { stock_entry_name: stockEntryName }\n    // });\n    \n    // returns an object with total items and scanned items\n    let varietyMatch = {};\n    \n    \n    try {\n        varietyMatch = await validateLabels(oplName, bunchStockEntryName);\n        \n    } catch (error) {\n        frappe.throw(`Error validating labels: ${error}`);\n        return;\n    }\n    \n    totalBunches = varietyMatch.totalItems;\n    scannedItems = varietyMatch.scannedItems;\n    \n    bunchName = stockEntryDoc.items[0]?.item_code;\n    \n    if (!varietyMatch.valid) {\n        frappe.throw(`${bunchName} does not match the Order Pick List!`);\n    } else {\n        // Show the number of bunches scanned and the bunches remaining\n        // Fetch from OPL and FPL\n        frappe.msgprint(`${scannedItems} of ${totalBunches} Bunches scanned!`);\n    }\n    \n    try {\n        await createStockEntry(bunchLabelData, farm, action);\n        frappe.msgprint(`Transfered stock successfully`);\n    } catch (error) {\n        frappe.throw(`Error creating stock entry: ${error}`);\n    }\n    \n    if (!boxStickerDocId) {\n        await createBoxSticker(oplName, bunchStockEntryName);\n    } else {\n        await addVarietyToBoxSticker(boxStickerDocId, bunchStockEntryName);\n    }\n    \n    await createOrGetFarmPackList(oplName, bunchStockEntryName);\n    \n    \n}\n\n\n\nasync function addVarietyToBoxSticker(boxStickerDocId, bunchStockEntryName) {\n    try {\n        const stockEntry = await frappe.db.get_doc(\"Stock Entry\", bunchStockEntryName);\n        \n        const variety = stockEntry.items[0].item_code;\n        const uom = stockEntry.items[0].uom;\n        \n        const response = frappe.call({\n            method: 'upande_tambuzi.server_scripts.add_variety_to_box_sticker.add_variety_to_sticker',\n            args: {\n                box_label_sticker_name: boxStickerDocId,\n                variety: variety,\n                uom: uom\n            },\n            callback: function (response) {\n                frappe.msgprint(`${variety} added to Box Label Sticker`);\n            }\n        });\n\n    } catch (err) {\n        frappe.throw(`Error adding ${variety} to Box Label Sticker: ${err}`);\n    }\n}\n\n\n\nasync function createBoxSticker(oplName, bunchStockEntryName) {\n    try {\n        const orderId = oplName;\n        \n        // Box Id should be numerical and autoincremental. Can be fetched from the\n        // name of the previous box sticker entry + 1\n        \n        // const lastBox = await frappe.db.get_value(\"Box Label\", {\"docstatus\": [\"!=\", 2]}, \"name\", {order_by: \"creation ASC\"});\n        \n        const boxes = await frappe.db.get_list(\"Box Label\", {\n            filters: { \"docstatus\": [\"!=\", 2] },\n            fields: [\"name\"],\n            order_by: \"creation DESC\"\n        });\n        \n        let newBoxNumber = 1;\n        \n        if (boxes.length > 0 && boxes[0].name) {\n            const match = boxes[0].name.match(/BOX-(\\d+)/);\n            if (match) {\n                newBoxNumber = parseInt(match[1]) + 1;\n            }\n        }\n        \n        const box_id = String(newBoxNumber).padStart(5, '0');\n        const stockEntryId = bunchStockEntryName;\n        \n        // Fetch Sales Order & Stock Entry\n        const orderPick = await frappe.db.get_doc(\"Order Pick List\", orderId);\n        \n        const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n        \n        const itemCode = stockEntry.items[0].item_code;\n        const uom = stockEntry.items[0].uom;\n        const length = stockEntry.custom_stem_length;\n        const customerId = orderPick.customer;\n        const sales_order = orderPick.sales_order;\n        \n        const salesOrderDoc = await frappe.db.get_doc(\"Sales Order\", sales_order);\n        const customerPurchaseOrder = salesOrderDoc.po_no;\n        \n        const response = await frappe.call({\n            method: 'upande_tambuzi.server_scripts.create_box_sticker.create_box_sticker',\n            args: {\n                variety: itemCode,\n                uom: uom,\n                customer: customerId,\n                length: length,\n                box_number: box_id,\n                customer_purchase_order: customerPurchaseOrder\n            },\n            callback: function (response) {\n                boxStickerDocId = response.message.docname\n                // frappe.msgprint(\"Started Creating Box Label Sticker!\")\n            }\n        })\n    } catch (err) {\n        frappe.throw(`Error creating Box Label: ${err}`)\n    }\n        \n}\n\n\n\nasync function createOrGetFarmPackList(oplName, bunchStockEntryName) {\n    const { sales_order, farm } = await getSalesOrderAndFarmFromOPL(oplName);\n    \n    if (!sales_order || farm == \"Unknown\" ) {\n        frappe.throw(\"Sales Order or Warehouse details missing in Order Pick List.\");\n        return;\n    }\n    \n    const existingFPL = await frappe.db.get_list(\"Farm Pack List\", {\n        filters: {\n            custom_sales_order: sales_order,\n            custom_farm: farm\n        },\n        fields: [\"name\"]\n        \n    });\n    \n    if (existingFPL.length > 0) {\n        farmPackListDocId = existingFPL[0].name;\n        await addBunchToFarmPackList(farmPackListDocId, bunchStockEntryName, oplName, farm);\n        frappe.msgprint(`Bunch added to existing Farm Pack List: ${farmPackListDocId}`);\n    } else {\n        await createFarmPackListEntry(bunchStockEntryName, oplName, farm);\n    }\n}\n\n\n\nasync function createFarmPackListEntry(bunchStockEntryName, oplName, farm) {\n    try {\n        const orderId = oplName;\n        const stockEntryId = bunchStockEntryName;\n        \n        // Fetch Sales Order & Stock Entry\n        const orderPick = await frappe.db.get_doc(\"Order Pick List\", orderId);\n        \n        const stockEntry = await frappe.db.get_doc(\"Stock Entry\", stockEntryId);\n    \n        if (!orderPick || !stockEntry || !stockEntry.items.length) {\n            frappe.throw(\"Invalid Sales Order or Stock Entry data\");\n        }\n    \n        const sourceWarehouse = `${farm} Dispatch Cold Store - TL`;\n        \n        const itemCode = stockEntry.items[0].item_code;\n        const uom = stockEntry.items[0].uom;\n        \n        // Quantity scanned should always be one per scan\n        const quantity = 1;\n        const customerId = orderPick.customer;\n        const sales_order_id = orderPick.sales_order;\n        \n        // Get box id from box label\n        const boxLabelDoc = await frappe.db.get_doc('Box Label', boxStickerDocId);\n        const boxId = boxLabelDoc.box_number;\n        \n        // Create new Farm Pack List document\n        const packListDoc = frappe.model.get_new_doc(\"Farm Pack List\");\n        packListDoc.custom_sales_order = sales_order_id;\n        packListDoc.custom_farm = farm;\n        packListDoc.pack_list_item = [{\n            item_code: itemCode,\n            uom: uom,\n            qty: quantity,\n            source_warehouse: sourceWarehouse,\n            sales_order_id: sales_order_id,\n            customer_id: customerId,\n            box_id: boxId\n        }];\n        \n        // Save document\n        const savedDoc = await frappe.db.insert(packListDoc);\n        \n        farmPackListDocId = savedDoc.name;\n    \n        frappe.msgprint(\"Farm Pack List entry created successfully!\");\n    } catch (error) {\n        console.error(\"Error saving Farm Pack List:\", error);\n        frappe.throw(`Error saving Farm Pack List: ${error.message}`);\n    }\n    \n} \n\n\n\nasync function addBunchToFarmPackList(farmPackListDocId, bunchStockEntryName, oplName, farm) {\n    \n    // Get box id from box label\n    const boxLabelDoc = await frappe.db.get_doc('Box Label', boxStickerDocId);\n    const boxId = boxLabelDoc.box_number;\n    \n    try {\n        await frappe.call({\n            method: 'upande_tambuzi.server_scripts.update_farm_pack_list.add_bunch_to_farm_pack_list',\n            args: {\n                farm_pack_list_doc_id: farmPackListDocId,\n                bunch_SE_name: bunchStockEntryName,\n                opl_name: oplName, \n                farm: farm,\n                box_id: boxId\n            },\n            callback: function (response) {\n                frappe.msgprint(`Added bunch to Farm Pack List: ${farmPackListDocId}`);\n            }\n        });\n    } catch (error) {\n        console.error('Error adding bunch to Farm Pack List:', error);\n        frappe.throw(`Error adding bunch to Farm Pack List: ${error}`);\n    }\n}\n\n\n\nasync function getSalesOrderAndFarmFromOPL(oplName) {\n    const oplDoc = await frappe.db.get_doc('Order Pick List', oplName);\n    \n    const farmName = oplDoc.locations[0].warehouse?.split(\" \")[0]\n                    || oplDoc.source_warehouse?.split(\" \")[0]\n                    || oplDoc.locations[0].custom_source_warehouse?.split(\" \")[0]\n                    || \"Unknown\";\n                    \n    return {\n        sales_order: oplDoc.sales_order,\n        farm: farmName\n    };\n}\n\nlet scannedBunches = 0;\n\nasync function validateLabels(oplName, bunchStockEntryName) {\n    let orderPickVariety;\n    let stockEntryVariety;\n    let totalBunches = 0;\n    \n    try {\n        const stockEntryDocument = await frappe.db.get_doc('Stock Entry', bunchStockEntryName);\n        \n        if (stockEntryDocument) {\n            stockEntryVariety = stockEntryDocument.items[0].item_code;\n        } else {\n            frappe.msgprint(`No Stock Entry found for ${bunchStockEntryName}`);\n        }\n    } catch (error) {\n        frappe.throw(`Error fetching Stock Entry: ${error}`);\n    }\n    \n    \n    try {\n        const orderPickList = await frappe.db.get_doc(\"Order Pick List\", oplName);\n        const numberOfItems = orderPickList.locations.length;\n        \n        if (!orderPickList || !orderPickList.locations || orderPickList.locations.length === 0) {\n            frappe.msgprint(`No valid Order Pick List found for ${oplName}`);\n            return { totalItems: 0, scannedItems: 0, valid: false };\n        }\n\n        \n        if (orderPickList) {\n\n            for (let i = 0; i < numberOfItems; i++) {\n                let currVariety = orderPickList.locations[i].item_code;\n                let numberOfBunches = orderPickList.locations[i].qty;\n                totalBunches += numberOfBunches \n                \n                if (currVariety == stockEntryVariety ) {\n                    orderPickVariety = currVariety;\n                    scannedBunches += 1;\n                }\n            }\n            \n        } else {\n            frappe.msgprint(`No Order Pick List found for ${oplName}`);\n        }\n    } catch (error) {\n        frappe.throw(`Error fetching Order Pick List: ${error}`);\n    }\n    \n    return {\n        totalItems: totalBunches,\n        scannedItems: scannedBunches,\n        valid: orderPickVariety === stockEntryVariety\n    };\n}\n\n\n\nfunction toggle_scan_data_field(frm) {\n    if (frm.doc.farm && frm.doc.action) {\n        frm.set_df_property('scan_data', 'hidden', 0);\n        \n        setTimeout(() => {\n            frm.fields_dict.scan_data.$wrapper.find('input').focus();\n        }, 300);\n\n    } else {\n        frm.set_df_property('scan_data', 'hidden', 1);\n    }\n}\n\n\n\nasync function createStockEntry(scan_value, farm, action) {\n    const stockEntryName = getNameFromUrl(scan_value);\n    \n\n    let variety;\n    let qty;\n    let breeder;\n    let grower;\n    let uom;\n    let harvester;\n    let greenhouse;\n    let block__bed_number;\n    let stockEntryDoc;\n    \n    // Use the stockEntryName to get the stock_entry_data field data needed for\n    // stock transfer\n    if (action == \"Receiving\") {\n        try {\n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n            \n            if (stockEntryDoc.custom_scanned ) {\n                frappe.throw(\"Bucket already scanned!\");\n                return;\n            }\n            \n            frappe.call({\n                method: \"upande_tambuzi.server_scripts.update_custom_scanned.update_custom_scanned\",\n                args: { stock_entry_name: stockEntryName }\n            });\n            \n        } catch (error) {\n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        const items = stockEntryDoc.items;\n        \n        breeder = stockEntryDoc.custom_breeder;\n        grower = stockEntryDoc.custom_grower;\n        greenhouse = stockEntryDoc.custom_greenhouse;\n        harvester = stockEntryDoc.custom_harvester;\n        block__bed_number = stockEntryDoc.custom_block__bed_number;\n\n        \n        items.forEach((item) => {\n            variety = item.item_code;\n            qty = item.qty;\n        });\n        \n        frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, No. of Stems: ${qty} `)\n    }\n    \n    if (action === \"Packing\") {\n        try {\n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName);\n            \n        } catch (error) {\n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        const items = stockEntryDoc.items;\n        \n        items.forEach((item) => {\n            variety = item.item_code;\n            \n            // Flowers are packed per 1 bunch\n            qty = 1;\n            uom = item.uom;\n        });\n    }\n    \n    if (action === 'Receiving Quarantined') {\n        try {\n            stockEntryDoc = await frappe.db.get_doc('Stock Entry', stockEntryName)\n            \n            if (stockEntryDoc.custom_scanned ) {\n                frappe.throw(\"Bucket already scanned!\");\n                return;\n            }\n            \n            frappe.call({\n                method: \"upande_tambuzi.server_scripts.update_custom_scanned.update_custom_scanned\",\n                args: { stock_entry_name: stockEntryName }\n            });\n            \n        } catch (error) {\n            frappe.throw(`Failed to fetch Stock Entry: ${error}`);\n        }\n        \n        const items = stockEntryDoc.items;\n        \n        breeder = stockEntryDoc.custom_breeder;\n        grower = stockEntryDoc.custom_grower;\n        greenhouse = stockEntryDoc.custom_greenhouse;\n        harvester = stockEntryDoc.custom_harvester;\n        block__bed_number = stockEntryDoc.custom_block__bed_number;\n\n        items.forEach((item) => {\n            variety = item.item_code;\n            qty = item.qty;\n        });\n        \n        frappe.msgprint(`Harvester: ${harvester}, Greenhouse: ${greenhouse}, Bay: ${block__bed_number}, No. of Stems: ${qty} `)\n        \n    }\n    \n    const stock_entry_type_mapping = {\n        \"Receiving\": \"Receiving\",\n        \"Packing\": \"Packing\",\n        \"Receiving Quarantined\": \"Receiving Quarantined\",\n    };\n    \n    const stock_entry_type = stock_entry_type_mapping[action];\n    \n    // Change the mapping of the location to check the location doctype \n    const locationMapping = {\n        \"Burguret Receiving\": { source: `${greenhouse}`, target: \"Burguret Receiving Cold Store - TL\" },\n        \"Burguret Receiving Quarantined\": { source: `${greenhouse}`, target: \"Burguret Quarantine Store - TL\" },\n        \"Burguret Packing\": { source: \"Burguret Graded Sold - TL\", target: \"Burguret Dispatch Cold Store - TL\" },\n\n        \"Turaco Receiving\": { source: `${greenhouse}`, target: \"Turaco Receiving Cold Store - TL\" },\n        \"Turaco Receiving Quarantined\": { source: `${greenhouse}`, target: \"Turaco Quarantine Store - TL\" },\n        \"Turaco Packing\": { source: \"Turaco Graded Sold - TL\", target: \"Turaco Dispatch Cold Store - TL\" },\n\n        \"Pendekeza Receiving\": { source: `${greenhouse}`, target: \"Pendekeza Receiving Cold Store - TL\" },\n        \"Pendekeza Receiving Quarantined\": { source: `${greenhouse}`, target: \"Pendekeza Quarantine Store - TL\" },\n        \"Pendekeza Packing\": { source: \"Pendekeza Graded Sold - TL\", target: \"Pendekeza Dispatch Cold Store - TL\" }\n    };\n    \n    const scanLocation = `${farm} ${action}`;\n    \n    const stockmvt = locationMapping[scanLocation];\n\n    if (!stockmvt) {\n        frappe.msgprint(`Invalid scan location: ${scanLocation}`);\n        return;\n    }\n    stock_entry_data = {\n        \"location data\": stockmvt,\n        \"variety\": variety,\n        \"quantity\": qty,\n        \"breeder\": breeder,\n        \"grower\": grower,\n        \"harvester\": harvester,\n        \"greenhouse\": greenhouse,\n        \"stock entry type\": stock_entry_type,\n        \"uom\": uom,\n        \"block__bed_number\": block__bed_number\n    };\n    \n    \n\n    const created_stock_entry = frappe.call({\n        method: \"upande_tambuzi.server_scripts.create_stock_entry.create_stock_entry\",\n        args: {\n            stock_entry_data: JSON.stringify(stock_entry_data),\n        }\n    });\n    \n    \n    \n\n\n    return created_stock_entry;\n\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Scan",
  "enabled": 1,
  "modified": "2025-02-17 14:11:29.778350",
  "module": "Upande Tambuzi",
  "name": "Close Box Button",
  "script": "frappe.ui.form.on('Scan', {\n\trefresh: function(frm) {\n        update_primary_action(frm);\n    },\n\n    action: function(frm) {\n        update_primary_action(frm);\n    },\n\n    farm: function(frm) {\n        update_primary_action(frm);\n    },\n    \n    opl_data: function(frm) {\n        update_primary_action(frm);\n    },\n    \n    scan_data: function(frm) {\n        update_primary_action(frm);\n    }\n});\n\n\nfunction update_primary_action(frm) {\n    if (frm.doc.action === 'Packing') {\n        frm.page.set_primary_action('Close Box', function() {\n            frm.save();\n        });\n    } else {\n        frm.page.set_primary_action(__('Save'), function() {\n            frm.save();\n        });\n    }\n}\n",
  "view": "Form"
 }
]